# 売掛管理機能（AR Management）

このドキュメントでは、請求書管理システムに追加された売掛管理機能について説明します。

## 概要

売掛管理機能は、未収請求書の管理、入金処理、債権の年齢分析、督促管理を提供します。
この機能は `FEATURE_AR_MANAGEMENT` フラグで制御され、既存の請求・見積機能には影響しません。

## 主な機能

### 1. 入金管理
- 入金の登録・閲覧・削除
- 顧客別入金履歴
- 入金方法とメモの記録

### 2. 消込（配分）管理
- 入金の請求書への配分
- 部分入金対応
- 複数請求書への配分
- 配分整合性チェック（入金額・請求額を超えない）

### 3. 売掛年齢表
- 顧客別年齢表（0-30日、31-60日、61-90日、90日以上）
- 請求別残高一覧
- 期限超過日数の表示
- CSVエクスポート機能

### 4. 督促管理
- 年齢区分別の督促ルール設定
- 督促メールのテンプレート管理
- ドライランモード（送信前プレビュー）
- 送信履歴の記録
- 日次自動チェック（Vercel Cron）

## データベース構造

### テーブル

#### payments（入金）
- 入金日、金額、入金方法、メモ
- 顧客との紐付け（オプション）

#### payment_allocations（入金配分）
- 入金と請求書の紐付け
- 配分金額
- 整合性チェックトリガー付き

#### dunning_rules（督促ルール）
- 年齢区分別のルール
- メール件名・本文テンプレート
- BCC設定、有効/無効フラグ

#### dunning_logs（督促ログ）
- 送信日時、チャネル、結果
- 監査証跡として保存

### ビュー

#### ar_aging_by_customer（顧客別年齢表）
- 顧客別の年齢区分別残高
- リアルタイム計算

#### ar_invoice_balance（請求別残高）
- 請求書別の残高、配分額、期限超過日数
- 年齢区分の自動分類

## API エンドポイント

### 入金
- `POST /api/payments` - 入金登録
- `GET /api/payments` - 入金一覧取得
- `GET /api/payments/[id]` - 入金詳細取得
- `DELETE /api/payments/[id]` - 入金削除

### 配分
- `POST /api/allocations` - 配分登録
- `DELETE /api/allocations?id=[id]` - 配分削除

### 年齢表
- `GET /api/ar/aging?view=customer` - 顧客別年齢表
- `GET /api/ar/aging?view=invoice` - 請求別残高

### 督促
- `POST /api/ar/dunning/send` - 督促送信
  - `dry_run=true` でプレビューモード
- `GET /api/ar/dunning/daily` - 日次自動チェック（Cron用）

## UI

### /ar/receivables（売掛管理）
- 未収請求書一覧
- 残高・期限超過日数・年齢区分表示
- サマリーカード（総残高、期限超過件数、平均回収日数）

### /ar/aging（年齢表）
- 顧客別年齢表
- CSVエクスポート機能
- 年齢区分別合計

## セットアップ

### 1. データベースマイグレーション

Supabase SQLエディタで以下を実行：

\`\`\`bash
# 00001_add_ar_management.sql を実行
\`\`\`

### 2. 環境変数設定

\`.env.local\` に以下を追加：

\`\`\`env
# Feature flag
NEXT_PUBLIC_FEATURE_AR_MANAGEMENT=1
FEATURE_AR_MANAGEMENT=1

# メール設定（オプション）
ENABLE_EMAIL_SENDING=0  # 1で有効化
CRON_SECRET=your_random_secret_key
\`\`\`

### 3. Vercel設定（本番環境）

Vercelダッシュボードで環境変数を設定：
- `NEXT_PUBLIC_FEATURE_AR_MANAGEMENT=1`
- `FEATURE_AR_MANAGEMENT=1`
- `ENABLE_EMAIL_SENDING=0`
- `CRON_SECRET=ランダムな文字列`

Cron Jobは自動的に設定されます（毎日9時に実行）。

## 使用方法

### 入金登録と消込

1. 売掛管理ページで「入金登録」をクリック
2. 入金日、金額、入金方法、メモを入力
3. 「消込」で請求書を選択して配分額を入力
4. 配分後、請求書の残高が自動更新

### 年齢表の確認

1. 年齢表ページで顧客別の債権状況を確認
2. CSVエクスポートで外部ツールと連携

### 督促送信

1. 督促ルールを作成（年齢区分、件名、本文テンプレート）
2. 売掛管理ページで督促対象の請求書を選択
3. ドライランモードで内容を確認
4. 実送信（ENABLE_EMAIL_SENDING=1の場合）

## 制限事項

- 負残高は禁止（整合性チェックで防止）
- 配分済み入金の削除は不可
- メール送信機能は未実装（SendGrid等の連携が必要）
- 日次Cronは提案のみ（自動送信はOFF）

## トラブルシューティング

### メニューが表示されない
- `NEXT_PUBLIC_FEATURE_AR_MANAGEMENT=1` が設定されているか確認
- 開発サーバーを再起動

### 配分時にエラーが出る
- 入金額を超えていないか確認
- 請求書の残高を超えていないか確認
- データベースのトリガーがエラーメッセージを返します

### Cronが動かない
- Vercelの環境変数 `CRON_SECRET` が設定されているか確認
- Cronログを確認（Vercelダッシュボード）

## 今後の拡張

- [ ] 入金・消込モーダルUI
- [ ] 督促送信モーダルUI
- [ ] SendGrid/Resend連携
- [ ] 請求詳細に入金/消込タブ追加
- [ ] 自動配分（FIFO/LIFO）
- [ ] 相殺処理
- [ ] 年齢表のMaterialized View化（パフォーマンス改善）

## ライセンス

既存の請求書管理システムと同じライセンスに従います。
