# マスターデータセットアップガイド

経費精算機能を使用するには、勘定科目・税率・経費カテゴリのマスターデータが必要です。

## 📋 概要

### 自動作成（推奨）

**新規テナントの場合は何もする必要がありません！**

テナント申請が承認されると、以下のデータが自動的に作成されます：

- ✅ **経費カテゴリ**（8種類）- 自動作成
  - 交通費、宿泊費、会議費、接待交際費、消耗品費、通信費、書籍・資料代、その他

### 手動作成（既存テナント向け）

既存テナントで経費精算機能を有効化する場合は、以下の手順でマスターデータを投入してください。

---

## 🚀 既存テナント向けセットアップ手順

### 方法A: 全テナント一括投入（推奨）

**すべての既存テナントに一括でマスターデータを投入する場合**

1. [Supabase Dashboard](https://supabase.com) にアクセス
2. プロジェクトを選択
3. 左メニューから **SQL Editor** をクリック
4. `00014_bulk_insert_master_data_for_all_tenants.sql` の内容を貼り付けて実行

このスクリプトは：
- ✅ すべてのアクティブなテナントを自動的に検出
- ✅ 各テナントに勘定科目・税率・経費カテゴリを投入
- ✅ 既存データは上書きせずスキップ（`ON CONFLICT DO NOTHING`）
- ✅ 処理結果を詳細に表示

実行後、以下のような結果が表示されます：

```
処理対象テナント数: 3
成功: 3
エラー: 0

【テナント別マスターデータ投入状況】
企業名          | 企業コード | 税率数 | 勘定科目数 | 経費カテゴリ数 | ステータス
---------------|----------|-------|----------|-------------|----------
株式会社A       | ABC123   | 5     | 38       | 8          | ✓ 完了
株式会社B       | DEF456   | 5     | 38       | 8          | ✓ 完了
株式会社C       | GHI789   | 5     | 38       | 8          | ✓ 完了
```

---

### 方法B: 特定テナントのみ投入

**特定のテナントだけにマスターデータを投入する場合**

#### ステップ1: テナントIDを確認

1. [Supabase Dashboard](https://supabase.com) にアクセス
2. プロジェクトを選択
3. 左メニューから **SQL Editor** をクリック
4. `00012_check_tenant_id.sql` の内容を貼り付けて実行

```sql
-- テナント一覧を表示
SELECT
  t.id AS tenant_id,
  t.company_name,
  t.company_code,
  COUNT(p.id) AS user_count
FROM tenants t
LEFT JOIN profiles p ON p.tenant_id = t.id
GROUP BY t.id, t.company_name, t.company_code
ORDER BY t.created_at DESC;
```

5. 結果から **tenant_id** (UUID形式) をコピー

---

#### ステップ2: マスターデータを投入

1. `00013_insert_master_data_with_tenant_id.sql` をテキストエディタで開く

2. **4箇所**の `'YOUR_TENANT_ID_HERE'` を、ステップ1でコピーしたテナントIDに置き換え

```sql
-- 【変更前】
v_tenant_id UUID := 'YOUR_TENANT_ID_HERE';

-- 【変更後（例）】
v_tenant_id UUID := 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';
```

置き換える箇所：
- 13行目: 変数宣言部分
- 194行目: 税率確認クエリ
- 207行目: 勘定科目確認クエリ
- 218行目: 経費カテゴリ確認クエリ

3. 編集したスクリプト全体をSupabase SQL Editorに貼り付け

4. **実行** をクリック

5. 成功メッセージを確認

```
✓ すべてのマスターデータ投入が完了しました！
```

---

#### ステップ3: 結果を確認

スクリプト実行後、以下のデータが表示されます：

#### 【税率マスター】（5種類）
- 課税10%
- 課税8%（軽減税率）
- 非課税
- 不課税
- 免税

#### 【勘定科目マスター】（約40科目）
- 資産: 現金、普通預金、売掛金など
- 負債: 買掛金、未払金、借入金など
- 純資産: 資本金、繰越利益剰余金など
- 収益: 売上高、受取利息など
- 費用: **旅費交通費、消耗品費、接待交際費など**（経費精算で使用）

#### 【経費カテゴリマスター】（8種類）
- 交通費 → 旅費交通費（6210）
- 宿泊費 → 旅費交通費（6210）
- 会議費 → 接待交際費（6260）
- 接待交際費 → 接待交際費（6260）
- 消耗品費 → 消耗品費（6230）
- 通信費 → 通信費（6220）
- 書籍・資料代 → 消耗品費（6230）
- その他 → 雑費（6910）

---

## 🎯 動作確認

### 経費申請画面で確認

1. アプリにログイン
2. 左サイドバーから **経理** → **経費精算** → **新規経費申請** をクリック
3. 以下が選択できることを確認：
   - ✅ **カテゴリ**（8種類）
   - ✅ **勘定科目**（費用科目のみ表示）
   - ✅ **税区分**（5種類）

### カテゴリ管理画面で確認

1. 左サイドバーから **経費カテゴリ** をクリック
2. 8つのデフォルトカテゴリが表示されることを確認
3. **カテゴリ追加** ボタンから新しいカテゴリを追加可能

---

## 📝 カスタマイズ

### 追加カテゴリの作成

1. **経費カテゴリ** 画面で **カテゴリ追加** をクリック
2. 以下を入力：
   - カテゴリ名（必須）
   - デフォルト勘定科目（任意）
   - デフォルト税率（任意）
3. **作成** をクリック

### 勘定科目の追加

将来的に会計コア機能から勘定科目を追加できるようになります。
現在は、スクリプトを編集してSQL Editorで実行してください。

---

## ⚠️ トラブルシューティング

### 「テナントIDが見つかりません」エラー

**原因**: `auth.uid()` がSupabase SQL Editorで使用できない

**解決策**: `00013_insert_master_data_with_tenant_id.sql` を使用して、テナントIDを直接指定してください

### 「経費カテゴリが表示されない」エラー

**原因**: マスターデータが投入されていない、または勘定科目・税率が存在しない

**解決策**:
1. ステップ2を実行して勘定科目と税率を作成
2. ブラウザをハードリフレッシュ（`Cmd+Shift+R` / `Ctrl+Shift+R`）

### 「ON CONFLICT」エラー

**原因**: 既にマスターデータが存在する

**解決策**: 問題ありません。スクリプトはON CONFLICT句で重複を無視します

---

## 📚 関連ファイル

- `00012_check_tenant_id.sql` - テナントID確認用
- `00013_insert_master_data_with_tenant_id.sql` - マスターデータ投入用（特定テナント向け）
- `00014_bulk_insert_master_data_for_all_tenants.sql` - マスターデータ投入用（全テナント一括）⭐推奨
- `/src/app/api/applications/[id]/approve/route.ts` - 新規テナント作成時の自動投入処理

---

## 🔧 技術詳細

### 経費カテゴリの関連性

経費カテゴリは、以下のデータと関連付けられています：

```
expense_categories
├── default_account_id → accounts(id)  -- デフォルト勘定科目
└── tax_rate_id → tax_rates(id)        -- デフォルト税率
```

### 新規テナント作成時の自動処理

`/src/app/api/applications/[id]/approve/route.ts` の `5.6` セクションで、以下が自動的に作成されます：

1. 既存の勘定科目（費用）を検索
2. 既存の税率を検索
3. 8つのデフォルト経費カテゴリを作成（勘定科目・税率が存在する場合は関連付け）

---

## 📧 サポート

問題が解決しない場合は、開発チームに連絡してください。
