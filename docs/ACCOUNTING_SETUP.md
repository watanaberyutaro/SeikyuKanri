# 会計コア機能セットアップガイド

本ドキュメントでは、請求書管理システムに追加された「会計コア」機能のセットアップ方法と使用方法を説明します。

## 概要

会計コア機能は、複式簿記に基づく本格的な会計システムです。以下の機能を提供します:

- **勘定科目マスタ**: 資産・負債・純資産・収益・費用の階層的な科目体系
- **税率マスタ**: 消費税率の管理（標準・軽減・非課税・対象外）
- **会計期間**: 会計年度と期間の管理、締め・ロック機能
- **仕訳入力**: 複合仕訳の入力、借貸一致チェック、税・部門対応
- **自動チェック**: 借貸一致、期間ロック、整合性検証

## 前提条件

- Supabaseプロジェクトが設定済みであること
- 既存の請求書管理機能が正常に動作していること
- マルチテナント対応のデータベース構造（tenant_id使用）

## セットアップ手順

### 1. データベースマイグレーション

Supabase SQL Editorで以下のマイグレーションを実行してください:

```bash
# ファイル: 00002_add_accounting_core.sql
```

このマイグレーションにより、以下のテーブルが作成されます:

- `accounts` - 勘定科目マスタ
- `tax_rates` - 税率マスタ
- `accounting_periods` - 会計期間マスタ
- `journals` - 仕訳帳
- `journal_lines` - 仕訳明細

また、以下の制約とトリガーも設定されます:

- 借方・貸方の合計一致チェック
- 会計期間ロック時の変更禁止
- RLS（Row Level Security）ポリシー

### 2. 環境変数の設定

`.env.local`に以下の環境変数を追加してください:

```env
# 会計コア機能を有効化
NEXT_PUBLIC_FEATURE_ACCOUNTING_CORE=1
FEATURE_ACCOUNTING_CORE=1
```

### 3. 開発サーバーの再起動

環境変数を読み込むため、開発サーバーを再起動してください:

```bash
npm run dev
```

### 4. 初期科目のインポート

会計コア機能を初めて使用する際は、初期科目テンプレートをインポートします。

**方法1: APIを使用（推奨）**

以下のエンドポイントにPOSTリクエストを送信:

```bash
curl -X POST http://localhost:3001/api/accounts/import \
  -H "Content-Type: application/json" \
  -H "Cookie: your-session-cookie"
```

**方法2: 手動インポート（UI実装後）**

1. サイドバーから「会計」→「勘定科目」を選択
2. 「初期科目をインポート」ボタンをクリック
3. 確認ダイアログでOKをクリック

インポートされる内容:

- 勘定科目: 58科目（資産・負債・純資産・収益・費用）
- 税率: 5種類（標準10%、軽減8%、旧8%、非課税、対象外）

## 使用方法

### 会計期間の設定

1. サイドバーから「会計」→「会計期間」を選択
2. 「新規作成」ボタンをクリック
3. 期間情報を入力:
   - 名称: 例「2024年度」
   - 開始日: 例「2024-04-01」
   - 終了日: 例「2025-03-31」
   - 事業年度: 例「2024」
   - ステータス: 「open」（開いている）
4. 保存

### 仕訳の入力

1. サイドバーから「会計」→「仕訳入力」を選択
2. 「新規仕訳」ボタンをクリック
3. 仕訳情報を入力:
   - 仕訳日: 仕訳を計上する日付
   - 摘要: 取引内容の説明
4. 借方・貸方の明細行を追加:
   - 勘定科目を選択
   - 金額を入力（借方または貸方）
   - 税率を選択（必要に応じて）
   - 部門を入力（必要に応じて）
5. 借方合計 = 貸方合計 であることを確認
6. 保存

**仕訳例: 売上計上**

```
日付: 2024-11-01
摘要: A社への売上

借方:
- 売掛金 ¥110,000

貸方:
- 売上高 ¥100,000 (税率: 標準10%)
- 仮受消費税 ¥10,000
```

### 勘定科目の管理

1. サイドバーから「会計」→「勘定科目」を選択
2. 科目一覧が階層表示されます
3. 新規作成:
   - 「新規作成」ボタンをクリック
   - 科目コード、名称、種類などを入力
   - 親科目を選択（階層構造を作る場合）
4. 編集・削除も同様に実行可能

**注意事項:**

- 仕訳で使用中の科目は削除できません
- 子科目がある親科目は削除できません

### 税率の管理

1. サイドバーから「会計」→「税率」を選択
2. 新規作成:
   - 「新規作成」ボタンをクリック
   - 税率名、税率（%）、区分、適用開始日を入力
   - 適用終了日は省略可能（継続中の場合）
3. 税率の変更履歴を管理できます

### 会計期間の締めとロック

**締め（closed）:**

1. 会計期間一覧から対象期間を選択
2. 「締める」ボタンをクリック
3. 確認後、ステータスが「closed」に変更

**ロック（locked）:**

1. 締められた期間を選択
2. 「ロック」ボタンをクリック
3. 確認後、ステータスが「locked」に変更

**重要:** ロックされた期間の仕訳は、登録・変更・削除ができなくなります。

## データ整合性とバリデーション

### 自動チェック機能

1. **借貸一致チェック**
   - 仕訳の借方合計と貸方合計が一致しない場合、登録を拒否
   - データベースレベルでトリガーにより保証

2. **期間ロックチェック**
   - ロックされた会計期間への仕訳登録・更新を禁止
   - データベーストリガーにより自動実行

3. **配分整合性チェック**
   - 配分額が入金額や請求額を超えないことを保証
   - 既存の売掛管理機能との統合

### RLS（Row Level Security）

すべてのテーブルにRLSが適用されており、以下を保証:

- ユーザーは自テナントのデータのみアクセス可能
- 他テナントのデータは完全に分離
- マルチテナント環境での安全性

## APIエンドポイント

### 勘定科目

- `GET /api/accounts` - 一覧取得
- `POST /api/accounts` - 新規作成
- `PATCH /api/accounts?id={id}` - 更新
- `DELETE /api/accounts?id={id}` - 削除
- `POST /api/accounts/import` - 初期科目インポート

### 税率

- `GET /api/tax-rates` - 一覧取得
- `POST /api/tax-rates` - 新規作成
- `PATCH /api/tax-rates?id={id}` - 更新
- `DELETE /api/tax-rates?id={id}` - 削除

### 会計期間

- `GET /api/periods` - 一覧取得
- `POST /api/periods` - 新規作成
- `PATCH /api/periods?id={id}` - 更新
- `PATCH /api/periods?id={id}&action=close` - 締め
- `PATCH /api/periods?id={id}&action=lock` - ロック
- `DELETE /api/periods?id={id}` - 削除

### 仕訳

- `GET /api/journals` - 一覧取得
- `POST /api/journals` - 新規作成
- `GET /api/journals/[id]` - 詳細取得
- `DELETE /api/journals/[id]` - 削除

## トラブルシューティング

### Q: 会計メニューがサイドバーに表示されない

A: 以下を確認してください:

1. `.env.local`に`NEXT_PUBLIC_FEATURE_ACCOUNTING_CORE=1`が設定されているか
2. 開発サーバーを再起動したか
3. ブラウザのキャッシュをクリアしたか

### Q: 初期科目のインポートが失敗する

A: 以下を確認してください:

1. データベースマイグレーション（00002_add_accounting_core.sql）が実行済みか
2. 既に勘定科目が登録されていないか（インポートは初回のみ可能）
3. Supabaseの接続が正常か

### Q: 仕訳が保存できない

A: 以下を確認してください:

1. 借方合計と貸方合計が一致しているか
2. 会計期間がロックされていないか
3. 勘定科目が有効（is_active=true）になっているか
4. 必須項目（仕訳日、勘定科目、金額）が入力されているか

### Q: 「会計期間がロックされています」エラー

A: 該当する会計期間のステータスを確認してください:

1. 会計期間一覧で期間を選択
2. ステータスが「locked」の場合、管理者権限で「open」に戻す
3. 必要に応じて新しい会計期間を作成

## ベストプラクティス

1. **会計期間の設定**
   - 期首に必ず会計期間を作成
   - 期末には必ず締めとロックを実行

2. **勘定科目の管理**
   - 初期科目をベースに、必要に応じて追加
   - 不要な科目は無効化（削除は避ける）
   - 科目体系の一貫性を保つ

3. **仕訳入力**
   - 摘要は具体的に記載
   - 税区分を正確に設定
   - 部門管理を活用

4. **バックアップ**
   - 定期的にSupabaseのバックアップを取得
   - 重要な会計期間の締め前には必ずバックアップ

## サポート

問題が解決しない場合は、以下の情報を添えて開発チームに連絡してください:

1. エラーメッセージの全文
2. 実行した操作の手順
3. ブラウザのコンソールログ
4. Supabaseのログ（該当する場合）

## 更新履歴

- **v1.0.0** (2025-01-XX): 会計コア機能の初回リリース
  - 勘定科目、税率、会計期間、仕訳機能の実装
  - 借貸一致、期間ロック、RLSの実装
  - 初期科目テンプレートの提供
